require_relative '../../../../test_helper'

include RedStack::Identity::Models

describe 'RedStack::Identity::Models::Project' do

  before do
    @os = new_openstack_session

    @admin               = TestFixtures.users[:admin]
    @admin_project       = TestFixtures.projects[:admin_project]
    @admin_default_token = Token.create(
                              connection: @os.connection,
                              attributes: {
                                username: @admin[:username], 
                                password: @admin[:password]
                              }
                            )
    @admin_scoped_token  = Token.create(
                             connection: @os.connection,
                             attributes: {
                               token:    @admin_default_token, 
                               project:  @admin_project[:name]
                             }
                           )
    
    @non_admin              = TestFixtures.users[:non_admin]
    @non_admin_project      = TestFixtures.projects[:non_admin_project]
    @nonadmin_default_token = Token.create(
                                connection: @os.connection,
                                attributes: {
                                  username: @non_admin[:username], 
                                  password: @non_admin[:password]
                                }
                              )
    @nonadmin_scoped_token  = Token.create(
                                connection: @os.connection,
                                attributes: {
                                  token:    @nonadmin_default_token, 
                                  project:  @non_admin_project[:name]
                                }
                              )
  end

  
  it 'retrieves projects' do
    projects = Project.find(
                 endpoint_type: 'public',
                 token:         @nonadmin_default_token, 
                 connection:    @os.connection
               )
    
    projects.must_be_instance_of Array
    projects.length.wont_be_nil
  end



  it 'retrieves all projects' do
    some_projects = Project.find(
                      endpoint_type: 'public',
                      token:         @nonadmin_default_token, 
                      connection:    @os.connection
                    )

    all_projects = Project.find(
                     endpoint_type: 'admin',
                     token:         @admin_scoped_token, 
                     connection:    @os.connection
                   )
    
    all_projects.length.must_be :>, some_projects.length
  end



  it 'creates a project' do
    attributes = {
      name:         'REDSTACK_CREATE_PROJECT_TEST',
      description:  'This is a project generated by RedStack',
      enabled:      true
    }
  
    project = Project.create(
                attributes: attributes, 
                token:      @admin_scoped_token,
                connection: @os.connection
              )
    
    project.must_be_instance_of Project
    project['name'].must_equal attributes[:name]
    project['description'].must_equal attributes[:description]
    project['enabled'].must_equal attributes[:enabled]
    
    # Cleanup
    project.delete! token: @admin_scoped_token, connection: @os.connection
  end
       
end